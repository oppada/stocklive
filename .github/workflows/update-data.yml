name: Auto Update Stock Data

on:
  schedule:
    # 한국 시간(KST) 기준 평일 08:50 ~ 16:30 사이 가동 (UTC 기준 23:50 ~ 07:30)
    - cron: '*/5 23 * * 0-4' # 08:50 ~ 08:55분대 (일~목 밤 시작)
    - cron: '*/5 0-6 * * 1-5' # 09:00 ~ 15:55분대 (월~금 낮)
    - cron: '0-30 7 * * 1-5' # 16:00 ~ 16:30분대 (월~금 마감)
  workflow_dispatch: # 수동으로도 실행 가능하게 설정

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: |
          cd api
          npm install

      - name: Run Update Script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          KIS_APP_KEY: ${{ secrets.KIS_APP_KEY }}
          KIS_SECRET_KEY: ${{ secrets.KIS_SECRET_KEY }}
          KIS_BASE_URL: ${{ secrets.KIS_BASE_URL }}
        run: |
          node api/forceUpdateToss.js
