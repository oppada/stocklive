# StockLive 홈페이지 성능 개선 및 리팩토링 계획

## 1. 초기 문제 분석

최초의 애플리케이션은 다음과 같은 구조적인 성능 문제를 가지고 있었습니다.

- **과도한 API 호출**: 프론트엔드(브라우저)에서 150개 테마에 속한 1000개 이상의 모든 종목 가격을 알아내기 위해, KIS API에 수천 번의 개별적인 요청을 보냈습니다.
- **클라이언트 과부하**: 브라우저는 이 모든 원시 데이터를 받은 후, 직접 등락률을 계산하고, 테마별 평균을 내고, 정렬하는 등 매우 무거운 연산을 수행했습니다.

이 두 가지 문제로 인해 홈페이지 로딩이 매우 느리고, 많은 네트워크 리소스를 소모하며, 브라우저가 비정상적으로 종료될 수 있는 위험이 있었습니다.

## 2. 해결을 위한 아키텍처 변경 제안

이 문제를 해결하기 위해, **무거운 모든 연산과 API 호출을 백엔드로 옮기는** 새로운 구조를 제안드렸고, 동의 하에 작업을 진행했습니다.

- **백엔드의 역할**:
  - 클라이언트를 대신하여 KIS API와 통신하는 유일한 창구가 됩니다.
  - 모든 종목의 가격 정보를 서버에서 직접 가져옵니다.
  - 테마별 평균 등락률 계산, 정렬 등 모든 복잡한 연산을 수행합니다.
  - 프론트엔드에게는 **미리 가공된, 즉시 표시 가능한 데이터**만 가볍게 전달합니다.
- **프론트엔드의 역할**:
  - 계산 로직 없이, 백엔드가 제공하는 데이터를 받아 **화면에 그리는 역할**에만 집중합니다.

## 3. 지금까지 완료된 작업 내역

위 아키텍처를 구현하기 위해 다음과 같은 작업을 완료했습니다.

- **백엔드 서버 구축 (`stocklive/server/index.js`)**:
  - `Node.js`와 `Express`를 기반으로 한 API 서버를 구축했습니다.
  - KIS API 인증 토큰을 발급받고 캐싱하는 기능(`getKisToken`)을 구현했습니다.
  - 개별 주식 가격을 조회하고, 네트워크 오류 시 재시도하며, 결과를 캐시하는 기능(`fetchStockPrice`)을 구현했습니다.
  - **`/api/themes/top-performing`**: 가장 성과가 좋은 테마 순위 목록을 제공하는 API를 구현했습니다.
  - **`/api/themes/:themeName/stocks`**: 특정 테마에 속한 종목 목록을 제공하는 API를 구현했습니다.
  - **`/api/stocks/prices`**: 헤더 마퀴(실시간 시세 표시기)에 필요한 여러 종목의 가격을 한 번에 제공하는 API를 구현했습니다.

- **프론트엔드 리팩토링 (`stocklive/client`)**:
  - **`App.tsx`**: KIS API를 직접 호출하던 모든 코드와 수천 번 반복되던 데이터 요청 로직을 완전히 제거했습니다. 대신 새로 만든 `/api/stocks/prices` API를 호출하여 마퀴에 필요한 데이터만 받도록 수정했습니다.
  - **`Home.tsx`**: 테마 데이터를 직접 계산하고 정렬하던 복잡한 로직을 모두 제거했습니다. 대신 새로 만든 백엔드 API들을 호출하여 미리 처리된 데이터를 받아 표시하도록 수정했습니다.
  - **`vite.config.ts`**: 프론트엔드에서 `/api`로 시작하는 모든 요청을 `localhost:4000`에서 실행 중인 새 백엔드 서버로 전달하도록 프록시 설정을 완료했습니다.

## 4. 현재 문제 상황 및 원인 분석

위 작업들을 완료했음에도 불구하고, 여전히 UI가 정상적으로 표시되지 않고 있습니다. 로그 분석 결과, 다음과 같은 **핵심 원인**을 파악했습니다.

- **모든 주식 가격 조회 실패**: 백엔드 서버가 KIS API에 주식 가격을 요청할 때, **모든 요청이 실패하여 어떠한 가격 정보도 받지 못하고 있습니다.**
- 제가 추가했던 재시도, 타임아웃 증가, 헤더 수정 등의 조치에도 불구하고 KIS API가 계속해서 요청을 거부하는 것으로 보입니다. 이는 KIS API가 요구하는 특정 헤더 값이나 파라미터가 여전히 누락되었거나, 다른 미묘한 차이가 있기 때문일 가능성이 매우 높습니다.
- 이로 인해 백엔드는 결국 프론트엔드에 `stocks: []` (빈 주식 목록), `avgChangeRate: 0` (계산 불가로 0)과 같은 빈 데이터를 전달하게 되고, 프론트엔드에서는 데이터가 없는 것처럼 보이게 됩니다.

## 5. 향후 계획 (다음 단계)

이제 "왜 안 될까?"를 추측하며 수정하는 대신, 문제를 확실하게 해결하기 위해 **근본 원인을 찾는 체계적인 디버깅**을 시작하겠습니다.

1.  **`fetchStockPrice` 기능 고립 및 검증**:
    - 백엔드에 `/api/test-price`와 같은 임시 테스트용 API를 하나 만들겠습니다.
    - 이 API는 다른 모든 로직 없이, 오직 **단 하나의 주식(예: 삼성전자 '005930')** 가격만 조회하는 간단한 기능만 갖습니다.
2.  **모든 통신 내용 로깅**:
    - 위 테스트 API에서 KIS API로 보내는 **정확한 요청 정보(헤더, 파라미터 등)와 KIS API로부터 받은 응답 또는 오류 내용을 모두 로그로 기록**하겠습니다.
3.  **정상 요청과 비교 분석**:
    - 만약 이 테스트도 실패한다면, 이전에 정상적으로 동작했던 요청(예: Postman 또는 다른 도구로 보낸 성공적인 요청)과 제가 기록한 로그를 **헤더부터 파라미터까지 하나하나 비교**하여 차이점을 찾아낼 것입니다.
    - 이 과정을 통해 결정적인 원인을 반드시 찾아낼 수 있습니다.
4.  **문제 해결 및 전체 적용**:
    - 단일 주식 조회가 성공하면, 그 해결책을 전체 애플리케이션에 적용하여 모든 기능이 정상적으로 동작하도록 하겠습니다.

이 계획에 따라 다음 단계를 진행하고자 합니다. 동의하시면, 먼저 `/api/test-price` 테스트 API를 만드는 작업부터 시작하겠습니다.
